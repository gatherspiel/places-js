function clearSessionStorage(){for(let t=0;t<sessionStorage.length;t++){const e=sessionStorage.key(t);sessionStorage.setItem(e,JSON.stringify({}))}}function getItemFromSessionStorage(t,e){const o=sessionStorage.getItem(t);if(!o)return null;const s=JSON.parse(o);return 0!==Object.keys(s).length&&e in s?s[e]:null}function updateSessionStorage(t,e,o){const s=sessionStorage.getItem(t);if(!s)throw new Error(`No cache defined for ${t}`);const n=JSON.parse(s);n[e]=o,sessionStorage.setItem(t,JSON.stringify(n))}function freezeState(t){if(!t||"{}"===JSON.stringify(t))return{};for(let[e,o]of Object.entries(t))t.hasOwnProperty(e)&&"object"==typeof o&&freezeState(o);return Object.freeze(t)}class DataStoreLoadAction{fetch(t,e){throw new Error(`fetch(params, cacheKey) method must be defined for ${this.constructor.name}`)}}class DataStore{static#t=0;#e=!1;#o=null;#s=[];#n;#i;constructor(t){this.#n=t,this.#s=[],this.#i=`data-store-${DataStore.#t}`,sessionStorage.setItem(this.#i,JSON.stringify({})),DataStore.#t++}getStoreData(){return this.#o}isWaitingForData(){return null!==this.#o&&void 0!==this.#o&&!this.#e}updateStoreData(t){this.#o={...this.#o,...freezeState(t)};for(let t=0;t<this.#s.length;t++)this.#s[t].updateFromSubscribedStores()}getSubscribedComponents(){return this.#s}async fetchData(t={},e){const o=this;if(!this.#e){this.#e=!0;const s=this.#n.getRequestConfig?this.#n.getRequestConfig(t):{};let n=null,i=null;if((o.#i||o.#i.length>0)&&(i=`${s.method??""}_${s.url}_${JSON.stringify(s.body)??""}`,console.log(i),n=getItemFromSessionStorage(this.#i,i)),null===n){for(let t=0;t<o.#s.length;t++)o.#s[t].lockComponent(o);if(e){const t=e.getSubscribedComponents();for(let o=0;o<t.length;o++)t[o].lockComponent(e)}n=await this.#n.fetch(t,o.#i,i),o.#o=n,o.#e=!1}else o.#o=n,o.#e=!1;for(let t=0;t<o.#s.length;t++)o.#s[t].unlockComponent(o),o.#s[t].updateFromSubscribedStores();if(e){const t=e.getSubscribedComponents();for(let o=0;o<t.length;o++)t[o].unlockComponent(e);e.updateStoreData(n)}return n}}unsubscribeComponent(t){const e=this.#s.indexOf(t);-1!==e?this.#s.splice(e,1):console.warn(`Attempt to unsubscribe ${t.constructor.name} from store it is not subscribed to`)}subscribeComponent(t){let e=0;for(;e<this.#s.length;){if(this.#s[e]===t){this.#s=this.#s.splice(e,1);break}e++}this.#s.push(t),this.isWaitingForData()||this.fetchData()}}class BaseDynamicComponent extends HTMLElement{#a=!1;#r=!1;#c=new Set;#d=0;componentStore={};#h;#l=[];constructor(t=[],e){super(),e&&(this.#h=e),this.#l=t;let o=!0;for(let t=0;t<this.#l.length;t++)o=o&&this.#l[t].dataStore.isWaitingForData(),this.#l[t].dataStore.subscribeComponent(this);o&&this.updateFromSubscribedStores(o)}lockComponent(t){if(this.#c.has(t)?console.warn(`Attempting to lock component ${this.constructor.name} multiple times`):this.#c.add(t),0===this.#d&&(this.#d=Date.now()),this.#h){if(null===this.shadowRoot){this.attachShadow({mode:"open"});const t=document.createElement("template");this.shadowRoot.appendChild(t.content.cloneNode(!0))}this.shadowRoot.innerHTML=this.getTemplateStyle()+this.#h.generateLoadingIndicatorHtml()}}unlockComponent(t){this.#c.delete(t)}disconnectedCallback(){for(let t=0;t<this.#l.length;t++)this.#l[t].dataStore.unsubscribeComponent(this)}updateData(t){this.#r&&console.warn(`Attempting to trigger multiple renders at the same time on component ${this.constructor.name}`),this.#r=!0,t&&(this.componentStore={...this.componentStore,...freezeState(t)},this.#u(this.componentStore),this.shadowRoot&&this.attachHandlersToShadowRoot&&!this.#a&&(this.attachHandlersToShadowRoot(this.shadowRoot),this.#a=!0),this.#r=!1)}updateFromSubscribedStores(){let t=!0;for(let e=0;e<this.#l.length;e++)t=t&&this.#l[e].dataStore.isWaitingForData();if(t){let t={};for(let e=0;e<this.#l.length;e++){const o=this.#l[e];let s=o.dataStore.getStoreData();if(o.componentReducer&&(s=o.componentReducer(s)),o.fieldName)t[o.fieldName]=s;else if(t=s,this.#l?.length>1)throw new Error(`Component ${this.constructor.name} is subscribed to multiple data stores. \n              Each one must be associated with a specified field name`)}this.updateData(t)}}#u(t){if(null===this.shadowRoot){this.attachShadow({mode:"open"});const t=document.createElement("template");this.shadowRoot.appendChild(t.content.cloneNode(!0))}if(this.#d>0){const e=Date.now()-this.#d;if(console.log(`Loaded data for ${this.constructor.name} in ${e} milliseconds`),this.#d=0,this.#h?.minTimeMs){const o=this.#h.minTimeMs-e,s=this;o>0?setTimeout((()=>{s.shadowRoot.innerHTML=this.getTemplateStyle()+this.render(t)}),o):this.shadowRoot.innerHTML=this.getTemplateStyle()+this.render(t)}else this.shadowRoot.innerHTML=this.getTemplateStyle()+this.render(t)}else this.shadowRoot.innerHTML=this.getTemplateStyle()+this.render(t)}render(t){throw new Error(`render(data) function for ${this.constructor.name} must be defined`)}getTemplateStyle(){throw new Error(`getTemplateStyle function for ${this.constructor.name} must be defined`)}}class BaseTemplateComponent extends HTMLElement{connectedCallback(){this.attachShadow({mode:"open"});if(!this.shadowRoot)throw new Error("shadowRoot is not defined");const t=this.getTemplateStyle(),e=document.createElement("template");e.innerHTML=t+"<div></div>",this.shadowRoot.appendChild(e.content.cloneNode(!0));const o=this.shadowRoot?.querySelector("div");if(!o)throw new Error("Failed to create template with a <div></div> section");o.innerHTML=this.render(),this.attachEventHandlersToDom&&this.attachEventHandlersToDom(this.shadowRoot)}}const ApiActionType=Object.freeze({GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE"});function getLocalStorageDataIfPresent(t){const e=window.localStorage.getItem(t);return e?JSON.parse(e):null}function addLocalStorageData(t,e){window.localStorage.setItem(t,e)}function deleteLocalStoreData(t){window.localStorage.getItem(t)&&window.localStorage.removeItem(t)}class ApiLoadAction extends DataStoreLoadAction{#S;constructor(t){super(),this.#S=t}getRequestConfig(t){return this.#S(t)}async fetch(t,e,o){const s=this.#S(t);s.headers||(s.headers={});const n=await ApiLoadAction.getResponseData(s);return e&&o&&(s.method&&s.method!==ApiActionType.GET&&clearSessionStorage(),updateSessionStorage(e,o,n)),n}static async#p(t,e){let o;const s=t.headers.get("content-type");return o=s&&s.includes("application/json")?await t.json():404===t.status?`Endpoint ${e} not found`:await t.text(),{status:t.status,errorMessage:o,endpoint:e}}static async getResponseData(t){const e=getLocalStorageDataIfPresent("authToken")?.access_token;e&&(t.headers?t.headers.authToken=e:t.headers={authToken:e});try{const e=await fetch(t.url.replace(/"/g,""),{method:t.method??ApiActionType.GET,headers:t.headers,body:t.body});if(200!==e.status)return await this.#p(e,t.url);return"application/json"===e.headers.get("content-type")?await e.json():(t.method!==ApiActionType.GET&&(console.log("Clearing response cache and other data in session storage"),clearSessionStorage()),{status:200})}catch(t){return{errorMessage:t.message}}}}class CustomLoadAction extends DataStoreLoadAction{#m;constructor(t){super(),this.#m=t}async fetch(t){return await this.#m(t)}}export{ApiActionType,ApiLoadAction,BaseDynamicComponent,BaseTemplateComponent,CustomLoadAction,DataStore,DataStoreLoadAction,addLocalStorageData,clearSessionStorage,deleteLocalStoreData,getLocalStorageDataIfPresent};